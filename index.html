<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>사랑방 띵곡 플레이어</title>
  <style>
    body{font-family:system-ui,-apple-apple-system,Segoe UI,Roboto,sans-serif;background:#111;color:#eee;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px;width:100%}
    .card{border:1px solid #444;border-radius:10px;padding:16px;margin:12px 0;background:#222;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#63b3ed;color:#fff;border:0;border-radius:999px;padding:.6rem 1rem;cursor:pointer;transition:background .2s}
    .btn:hover{background:#4299e1}
    .muted{color:#a0aec0}
    input{background:#1f2937;color:#eee;border:1px solid #374151;border-radius:8px;padding:.55rem .7rem;flex:1;min-width:220px;outline:none;transition:border-color .2s}
    input:focus{border-color:#63b3ed}
    .item{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;border-bottom:1px solid #2f3743}
    .item:hover{background:#2a3340}
    .item:last-child{border-bottom:none}
    .item .delete-btn{background:none;border:none;color:#fc8181;cursor:pointer;font-size:1.2em;line-height:1;margin-left:10px;opacity:.7;transition:opacity .2s}
    .item .delete-btn:hover{opacity:1}
    .video-player{aspect-ratio:16/9;width:100%;max-width:800px;margin:8px auto;border-radius:8px;overflow:hidden;position:relative}
    .main-title{text-align:center}
    .sub-title{text-align:center;font-size:.9em;margin-top:-15px;color:#a0aec0}
    .message-box{display:none;background:#2d3748;color:#fff;padding:12px;border-radius:8px;text-align:center;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000}
    .playback-controls{display:flex;align-items:center;gap:8px;margin-top:10px}
    #player{pointer-events:auto}

    /* 오버레이: 컨테이너는 통과, 블록이 차단 */
    .video-overlay-unclickable{
      position:absolute;top:0;left:0;width:100%;height:100%;
      pointer-events:none;opacity:1;transition:opacity .3s ease-in-out;z-index:10;
    }
    .video-overlay-unclickable.hidden{opacity:0;pointer-events:none}
    .video-block{position:absolute;background:rgba(0,0,0,.1);pointer-events:auto;z-index:10}

    /* 중앙 구멍: 클릭 통과 */
    .video-overlay-hole{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:100px;height:100px;pointer-events:none;border-radius:10px;z-index:11
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <!-- YouTube iFrame Player API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div id="message-box" class="message-box"></div>
<div class="wrap">
  <div class="main-title">
    <h1 id="title-text"><span id="prev-song-trigger">사</span>랑방 띵곡 플레이<span id="next-song-trigger">어</span></h1>
    <p class="sub-title">작가님들의 띵곡을 추천해주세요</p>
  </div>

  <div class="card">
    <div class="video-player">
      <div id="player"></div>
      <div id="video-overlay-unclickable" class="video-overlay-unclickable">
        <div id="blk-top" class="video-block"></div>
        <div id="blk-left" class="video-block"></div>
        <div id="blk-right" class="video-block"></div>
        <div id="blk-bottom" class="video-block"></div>
      </div>
      <div id="video-overlay-hole" class="video-overlay-hole"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="url" placeholder="유튜브 링크 또는 ID를 붙여넣기"/>
      <button id="add" class="btn">추가</button>
    </div>

    <div id="manual-input" style="display:none;margin-top:10px">
      <div class="row"><input id="manualTitle" placeholder="제목을 수동으로 입력해주세요"/></div>
      <div class="row" style="margin-top:10px"><input id="manualArtist" placeholder="아티스트를 수동으로 입력해주세요"/></div>
    </div>

    <div class="playback-controls">
      <button id="volumeBtn" class="btn">볼륨</button>
      <input type="range" id="volumeSlider" min="0" max="100" value="100">
    </div>

    <div id="playlist" class="card" style="margin:10px 0 0 0">
      <div class="muted">재생목록이 비어있습니다.</div>
    </div>
  </div>
</div>

<script>
  /* YouTube Data API 키 */
  const YOUTUBE_API_KEY = "AIzaSyB2GymrywkBYx4Mbt_xHNiYEV44MbfKY2w";

  /* Firebase 설정 */
  const firebaseConfig = {
    apiKey: "AIzaSyDz6xGJNKXinG5rREjdrPz7toIYGZXzilU",
    authDomain: "sarangbangmusicplaylist.firebaseapp.com",
    projectId: "sarangbangmusicplaylist",
    storageBucket: "sarangbangmusicplaylist.appspot.com",
    messagingSenderId: "193412502606",
    appId: "1:193412502606:web:0f7f9ddbef1ee6711d1ff",
    measurementId: "G-L14GH3BHYD"
  };

  /* 요소 */
  const urlInput = document.getElementById('url');
  const addBtn = document.getElementById('add');
  const listEl = document.getElementById('playlist');
  const messageBox = document.getElementById('message-box');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeBtn = document.getElementById('volumeBtn');
  const overlay = document.getElementById('video-overlay-unclickable');
  const hole = document.getElementById('video-overlay-hole');
  const manualInputDiv = document.getElementById('manual-input');
  const manualTitleInput = document.getElementById('manualTitle');
  const manualArtistInput = document.getElementById('manualArtist');
  const prevSongTrigger = document.getElementById('prev-song-trigger');
  const nextSongTrigger = document.getElementById('next-song-trigger');

  /* 상태 */
  const appId = 'default-app-id';
  const clientId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random());
  const globalState = { playlist: [], videoId:'', timestamp:0, lastUpdatedBy:null, lastVolume:100, currentPlayingIndex:-1 };
  let authed=false, player, playerReady=false, isManuallyAdding=false, isLoadingNext=false;

  function showMessage(msg, type='info'){
    messageBox.textContent = msg;
    messageBox.style.background = type==='error' ? '#fc8181' : '#2d3748';
    messageBox.style.display='block';
    setTimeout(()=>{ messageBox.style.display='none'; }, 2000);
  }

  function showOverlay(){ overlay.classList.remove('hidden'); hole.classList.remove('hidden'); }
  function hideOverlay(){ overlay.classList.add('hidden'); hole.classList.add('hidden'); }

  /* 구멍 주변 4블록 배치 */
  function layoutOverlayHole(){
    const wrap = document.querySelector('.video-player');
    const rWrap = wrap.getBoundingClientRect();
    const rHole = hole.getBoundingClientRect();
    const x1 = rHole.left - rWrap.left, y1 = rHole.top - rWrap.top;
    const x2 = x1 + rHole.width, y2 = y1 + rHole.height;

    const top = document.getElementById('blk-top');
    const left = document.getElementById('blk-left');
    const right = document.getElementById('blk-right');
    const bottom = document.getElementById('blk-bottom');

    top.style.cssText    = `left:0;top:0;width:100%;height:${y1}px;`;
    bottom.style.cssText = `left:0;top:${y2}px;width:100%;height:${rWrap.height-y2}px;`;
    left.style.cssText   = `left:0;top:${y1}px;width:${x1}px;height:${rHole.height}px;`;
    right.style.cssText  = `left:${x2}px;top:${y1}px;width:${rWrap.width-x2}px;height:${rHole.height}px;`;
  }
  let _layoutReq=null;
  function scheduleLayoutHole(){
    if(_layoutReq) return;
    _layoutReq = requestAnimationFrame(()=>{ _layoutReq=null; layoutOverlayHole(); });
  }

  /* Firebase 부팅 */
  async function boot(){
    try{ firebase.initializeApp(firebaseConfig); } catch(e){ console.error("Firebase init fail:", e.message); return; }
    try{ await firebase.auth().signInAnonymously(); authed=true; } catch(e){ console.error("Auth fail:", e.message); return; }
    const db = firebase.firestore();
    try{
      const pingRef = db.collection('artifacts').doc(appId).collection('public').doc('_ping');
      await pingRef.set({ pong:true, by:clientId, at:new Date() }, { merge:true });
    }catch(e){ console.error("Firestore write fail:", e.message); }

    startRealtime();
    wireUI();
  }

  /* YouTube API 콜백 — 전역 필요 */
  function onYouTubeIframeAPIReady(){
    playerReady = true;
    player = new YT.Player('player',{
      height:'100%', width:'100%', videoId:'',
      playerVars:{ autoplay:0, controls:1, disablekb:1, fs:0, iv_load_policy:3, modestbranding:1, rel:0, showinfo:0 },
      events:{ onStateChange:onPlayerStateChange, onReady:onPlayerReady }
    });
  }
  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

  function onPlayerReady(){
    scheduleLayoutHole(); // 위치 계산
    // 오버레이 표시/숨김은 상태변화에서만 제어
  }

  function onPlayerStateChange(event){
    switch(event.data){
      case YT.PlayerState.ENDED:
        if(!isLoadingNext){
          isLoadingNext = true;
          showOverlay();         // 끝났을 때만 표시
          playRandomVideo();
        }
        break;
      case YT.PlayerState.PLAYING:
        hideOverlay();           // 재생 시작되면 숨김
        isLoadingNext = false;
        const vid = player.getVideoData().video_id;
        if(vid && vid.length===11){
          globalState.videoId = vid;
          globalState.timestamp = player.getCurrentTime();
          savePlaybackState();
        }
        break;
      case YT.PlayerState.PAUSED:
        showOverlay();           // 일시정지 시 표시
        globalState.timestamp = player.getCurrentTime();
        savePlaybackState();
        break;
      default: break;
    }
  }

  /* 저장 */
  let playbackSaveTimer=null, playlistSaveTimer=null;

  function savePlaybackState(){
    if(!authed) return;
    if(playbackSaveTimer) clearTimeout(playbackSaveTimer);
    playbackSaveTimer = setTimeout(async()=>{
      try{
        const db = firebase.firestore();
        const ref = db.collection('artifacts').doc(appId).collection('public')
                      .doc('data').collection('playback_state').doc('main_state');
        await ref.set({
          videoId: globalState.videoId,
          timestamp: globalState.timestamp,
          lastUpdatedBy: clientId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        },{ merge:true });
      }catch(e){ console.error("savePlayback fail:", e.message); }
    },300);
  }

  function savePlaylistState(){
    if(!authed) return;
    if(playlistSaveTimer) clearTimeout(playlistSaveTimer);
    playlistSaveTimer = setTimeout(async()=>{
      try{
        const db = firebase.firestore();
        const ref = db.collection('artifacts').doc(appId).collection('public')
                      .doc('data').collection('playlist_state').doc('main_playlist');
        await ref.set({
          playlist: globalState.playlist,
          lastUpdatedBy: clientId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        },{ merge:true });
      }catch(e){ console.error("savePlaylist fail:", e.message); }
    },300);
  }

  function startRealtime(){
    const db = firebase.firestore();

    const playbackRef = db.collection('artifacts').doc(appId).collection('public')
                          .doc('data').collection('playback_state').doc('main_state');
    playbackRef.onSnapshot(snap=>{
      if(!snap.exists) return;
      const state = snap.data()||{};
      if(state.lastUpdatedBy===clientId) return;
      try{
        if(playerReady && state.videoId && globalState.videoId !== state.videoId){
          player.loadVideoById(state.videoId);
          player.seekTo(Number(state.timestamp)||0, true);
        }
      }catch(e){ console.error("Playback sync error:", e); }
    }, err=>console.error("Playback sub error:", err.message));

    const playlistRef = db.collection('artifacts').doc(appId).collection('public')
                          .doc('data').collection('playlist_state').doc('main_playlist');
    playlistRef.onSnapshot(snap=>{
      if(!snap.exists){ savePlaylistState(); return; }
      const d = snap.data()||{};
      if(d.lastUpdatedBy===clientId) return;
      globalState.playlist = Array.isArray(d.playlist)? d.playlist : [];
      renderList();
    }, err=>console.error("Playlist sub error:", err.message));
  }

  function updatePlaylist(newList){
    globalState.playlist = newList;
    renderList();
    savePlaylistState();
  }

  /* 렌더/플레이 */
  function renderList(){
    listEl.innerHTML='';
    if(!globalState.playlist.length){
      listEl.innerHTML = '<div class="muted">재생목록이 비어있습니다.</div>';
      showOverlay(); // 비었을 때만 표시
      return;
    }
    globalState.playlist.forEach((item, idx)=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `<span>${item.artist} - ${item.title}</span><button class="delete-btn" data-index="${idx}">&#x2715;</button>`;
      div.querySelector('.delete-btn').addEventListener('click', e=>{
        e.stopPropagation();
        const i = +e.target.dataset.index;
        const nl = [...globalState.playlist]; nl.splice(i,1); updatePlaylist(nl);
      });
      listEl.appendChild(div);
    });

    if(globalState.playlist.length>0 && (!player || !player.getVideoData())) playRandomVideo();
  }

  function getVideoId(input){
    if(!input) return null;
    const s = input.trim();
    if(/^[A-Za-z0-9_-]{11}$/.test(s)) return s; // 순수 ID
    const url = s.replace('music.youtube.com','www.youtube.com');
    const m = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i);
    return m ? m[1] : null;
  }

  async function fetchVideoDetails(videoId){
    const api = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
    const res = await fetch(api);
    if(!res.ok) throw new Error(`API Error: ${res.status} ${res.statusText}`);
    const data = await res.json();
    if(!data.items?.length) throw new Error('Failed to find video information.');
    const sn = data.items[0].snippet;
    return { title: sn.title, artist: sn.channelTitle };
  }

  function playVideo(index){
    if(!globalState.playlist.length){ showMessage('재생목록이 비어있습니다. 먼저 곡을 추가.'); return; }
    if(index>=globalState.playlist.length) index=0;
    if(index<0) index=globalState.playlist.length-1;
    const next = globalState.playlist[index];
    if(next && player){
      try{
        player.loadVideoById(next.videoId, 0);
        player.playVideo();
        globalState.currentPlayingIndex = index;
      }catch(e){ console.error('play error:', e); }
    }
  }

  function playRandomVideo(){
    if(!globalState.playlist.length) return;
    const idx = Math.floor(Math.random()*globalState.playlist.length);
    playVideo(idx);
  }
  function playNext(){
    if(!globalState.playlist.length) return;
    const idx = (globalState.currentPlayingIndex+1)%globalState.playlist.length;
    playVideo(idx);
  }
  function playPrev(){
    if(!globalState.playlist.length) return;
    const idx = (globalState.currentPlayingIndex-1+globalState.playlist.length)%globalState.playlist.length;
    playVideo(idx);
  }

  function wireUI(){
    addBtn.addEventListener('click', async ()=>{
      if(isManuallyAdding){
        const id = getVideoId((urlInput.value||'').trim());
        const title = manualTitleInput.value.trim();
        const artist = manualArtistInput.value.trim();
        if(!id) return showMessage('유효한 유튜브 링크 또는 ID 입력', 'error');
        if(!title || !artist) return showMessage('제목과 아티스트 모두 입력', 'error');
        updatePlaylist([...globalState.playlist, { title, artist, videoId:id }]);
        urlInput.value=''; manualTitleInput.value=''; manualArtistInput.value='';
        isManuallyAdding=false; manualInputDiv.style.display='none'; addBtn.textContent='추가';
        return;
      }

      const id = getVideoId((urlInput.value||'').trim());
      if(!id) return showMessage('유효한 유튜브 링크 또는 ID 입력', 'error');
      addBtn.textContent='불러오는 중...'; addBtn.disabled=true;
      try{
        const meta = await fetchVideoDetails(id);
        updatePlaylist([...globalState.playlist, { title:meta.title, artist:meta.artist, videoId:id }]);
        urlInput.value='';
      }catch(e){
        updatePlaylist([...globalState.playlist, { title:`YouTube ${id}`, artist:'Unknown', videoId:id }]);
        showMessage('API 제한으로 기본 제목으로 추가했습니다.');
      }finally{
        addBtn.disabled=false; addBtn.textContent='추가';
        isManuallyAdding=false; manualInputDiv.style.display='none';
      }
    });

    volumeSlider.addEventListener('input', ()=>{
      if(playerReady){
        player.setVolume(volumeSlider.value);
        if(player.isMuted()) player.unMute();
        globalState.lastVolume = volumeSlider.value;
      }
    });
    volumeBtn.addEventListener('click', ()=>{
      if(!playerReady) return;
      if(player.isMuted()){ player.unMute(); player.setVolume(globalState.lastVolume); volumeSlider.value=globalState.lastVolume; }
      else { globalState.lastVolume = player.getVolume(); player.mute(); volumeSlider.value=0; }
    });

    prevSongTrigger.addEventListener('click', ()=>{ playPrev(); showMessage('이전 곡'); });
    nextSongTrigger.addEventListener('click', ()=>{ playNext(); showMessage('다음 곡'); });
  }

  window.onload = function(){
    boot();
    scheduleLayoutHole();
    window.addEventListener('resize', scheduleLayoutHole);
  };
</script>
</body>
</html>
