<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>유튜브 셔플 플레이어</title>
  <style>
    body { font-family: system-ui, -apple-apple-system, Segoe UI, Roboto, sans-serif; background: #111; color: #eee; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; width: 100%; }
    .card { border: 1px solid #444; border-radius: 10px; padding: 16px; margin: 12px 0; background: #222; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .btn { background: #63b3ed; color: #fff; border: 0; border-radius: 999px; padding: .6rem 1rem; cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: #4299e1; }
    .ok { color: #81e6d9; }
    .fail { color: #fc8181; }
    .muted { color: #a0aec0; }
    input { background: #1f2937; color: #eee; border: 1px solid #374151; border-radius: 8px; padding: .55rem .7rem; flex: 1; min-width: 220px; outline: none; transition: border-color 0.2s; }
    input:focus { border-color: #63b3ed; }
    .item { display: flex; justify-content: space-between; align-items: center; padding: .5rem .6rem; border-bottom: 1px solid #2f3743; cursor: default; }
    .item:hover { background: #2a3340; }
    .item:last-child { border-bottom: none; }
    .item .delete-btn { background: none; border: none; color: #fc8181; cursor: pointer; font-size: 1.2em; line-height: 1; margin-left: 10px; opacity: 0.7; transition: opacity 0.2s; }
    .item .delete-btn:hover { opacity: 1; }
    .video-player { aspect-ratio: 16 / 9; width: 100%; max-width: 800px; margin: 8px auto; border-radius: 8px; overflow: hidden; position: relative; }
    .video-player:after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: not-allowed; }
    h1 { text-align: center; }
    .message-box { display: none; background: #2d3748; color: #fff; padding: 12px; border-radius: 8px; text-align: center; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
    .volume-controls { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .volume-controls .btn { padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
    .volume-controls .btn svg { width: 20px; height: 20px; }
    .loading-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 5px; z-index: 10; }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
  <!-- YouTube iFrame Player API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div id="message-box" class="message-box"></div>
<div class="wrap">
  <h1>유튜브 셔플 플레이어</h1>
  
  <div class="card">
    <div class="video-player">
      <div id="player"></div>
      <div id="loading-message" class="loading-message" style="display: none;">동영상 로딩 중...</div>
    </div>
    
    <div class="row" style="margin-top:10px">
      <input id="url" placeholder="유튜브 링크 또는 ID를 붙여넣기"/>
      <button id="add" class="btn">추가</button>
    </div>
    
    <div class="volume-controls">
      <button id="volumeBtn" class="btn">
        <svg id="volume-up-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.81 5 3.54 5 6.71s-2.11 5.9-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" style="display: none;">
          <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.23 21 13.13 21 12c0-4.41-3.59-8-8-8-1.06 0-2.06.24-2.98.65l1.74 1.74c.64-.26 1.35-.4 2.06-.4 2.89 0 5.35 1.93 6.04 4.56zM4.34 2.26L2.21 4.39l2.03 2.03zm0 9.28L2.21 13.66l2.03 2.03L1.58 17.1c-.85-.85-1.58-1.84-2.1-2.95l1.66-1.66zm15.1-6.19L16.54 7.5L14 5.07V4c0-2.21-1.79-4-4-4s-4 1.79-4 4v.07L1 2.92z"/>
        </svg>
      </button>
      <input type="range" id="volumeSlider" min="0" max="100" value="100">
    </div>

    <div id="playlist" class="card" style="margin:10px 0 0 0">
      <div class="muted">재생목록이 비어있습니다.</div>
    </div>
  </div>
</div>

<script>
  const YOUTUBE_API_KEY = "AIzaSyB2GymrywkBYx4Mbt_xHNiYEV44MbfKY2w";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDz6xGJNKXinG5rREjdrPz7toIYGZXzilU",
    authDomain: "sarangbangmusicplaylist.firebaseapp.com",
    projectId: "sarangbangmusicplaylist",
    storageBucket: "sarangbangmusicplaylist.appspot.com",
    messagingSenderId: "193412502606",
    appId: "1:193412502606:web:0f7f9ddbef1ee6711d1ff",
    measurementId: "G-L14GH3BHYD"
  };

  // ----- 요소 -----
  const urlInput = document.getElementById('url');
  const addBtn = document.getElementById('add');
  const listEl = document.getElementById('playlist');
  const messageBox = document.getElementById('message-box');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeBtn = document.getElementById('volumeBtn');
  const loadingMessage = document.getElementById('loading-message');

  // ----- 상태/가드 -----
  const appId = 'default-app-id';
  const clientId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random());
  let authed = false;
  let saveTimer = null;
  let localPlaylist = [];
  let player;
  let playerReady = false;
  let currentVideoId = ''; 
  let lastVolume = 100;

  function showMessage(message, type = 'info') {
    messageBox.textContent = message;
    if (type === 'error') {
      messageBox.style.background = '#fc8181';
    } else {
      messageBox.style.background = '#2d3748';
    }
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, 3000);
  }

  // ----- Firebase 초기화 + 익명 로그인 + 진단 -----
  async function boot() {
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase 초기화 성공");
    } catch (e) {
      console.error("Firebase 초기화 실패: " + e.message);
      return;
    }

    try {
      await firebase.auth().signInAnonymously();
      authed = true;
      console.log("익명 로그인 성공, 사용자 ID:", firebase.auth().currentUser.uid);
    } catch (e) {
      console.error("인증 실패: " + e.message);
      return;
    }

    // Firestore ping
    const db = firebase.firestore();
    try {
      const pingRef = db.collection('artifacts').doc(appId).collection('public').doc('_ping');
      await pingRef.set({ pong: true, by: clientId, at: new Date() }, { merge: true });
      console.log("Firestore 쓰기 성공");
    } catch (e) {
      console.error("Firestore 쓰기 실패: " + e.message);
    }

    startRealtime();
    wireUI();
  }

  // 유튜브 플레이어 API가 로드되면 호출되는 함수
  function onYouTubeIframeAPIReady() {
    playerReady = true;
    player = new YT.Player('player', {
      height: '100%',
      width: '100%',
      videoId: '',
      playerVars: {
        'autoplay': 1,
        'controls': 0,
        'disablekb': 1,
        'fs': 0,
        'iv_load_policy': 3,
        'modestbranding': 1,
        'rel': 0,
        'showinfo': 0
      },
      events: {
        'onStateChange': onPlayerStateChange,
        'onReady': onPlayerReady
      }
    });
  }

  // 유튜브 플레이어가 준비되면 호출
  function onPlayerReady(event) {
    console.log('YouTube Player is ready.');
    playNext();
  }

  // 유튜브 플레이어 상태 변경 시 호출
  function onPlayerStateChange(event) {
    switch (event.data) {
        case YT.PlayerState.ENDED:
            playNext();
            loadingMessage.style.display = 'none';
            break;
        case YT.PlayerState.PLAYING:
            debouncedSave(currentState());
            loadingMessage.style.display = 'none';
            break;
        case YT.PlayerState.PAUSED:
            loadingMessage.style.display = 'none';
            break;
        case YT.PlayerState.BUFFERING:
            loadingMessage.style.display = 'block';
            break;
    }
  }

  // ----- 저장/동기화 -----
  function debouncedSave(state) {
    if (!authed || !playerReady) return;
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => saveState(state), 300);
  }

  async function saveState(state) {
    if (!state || !state.videoId) {
      console.error("State or videoId is undefined. Skipping save.");
      return;
    }
    try {
      const db = firebase.firestore();
      const ref = db.collection('artifacts').doc(appId).collection('public')
        .doc('data').collection('playback_state').doc('main_state');
      const safe = {
        timestamp: player ? player.getCurrentTime() : 0,
        videoId: state.videoId,
        playlist: Array.isArray(state.playlist) ? state.playlist : [],
        lastUpdatedBy: clientId,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await ref.set(safe, { merge: true });
    } catch (e) {
      console.error("상태 저장 실패: " + e.message);
    }
  }

  function startRealtime() {
    const db = firebase.firestore();
    const ref = db.collection('artifacts').doc(appId).collection('public')
      .doc('data').collection('playback_state').doc('main_state');

    ref.onSnapshot(async (snap) => {
      if (!snap.exists) {
        // Firestore 문서가 존재하지 않을 경우 초기 상태를 저장
        debouncedSave(currentState());
        return;
      }
      const state = snap.data() || {};
      
      // CRITICAL FIX: Prevent self-updates from causing a loop
      if (state.lastUpdatedBy === clientId) {
          return;
      }

      try {
        const remoteList = Array.isArray(state.playlist) ? state.playlist : [];
        if (JSON.stringify(remoteList) !== JSON.stringify(localPlaylist)) {
          localPlaylist = remoteList;
          renderList();
        }
        
        const playerVideoId = player.getVideoData()?.video_id;
        if (playerReady && state.videoId && playerVideoId !== state.videoId) {
            player.loadVideoById(state.videoId);
            player.seekTo(state.timestamp, true);
        }

      } catch (e) {
        console.error("동기화 오류:", e);
      }
    }, (err) => { console.error("구독 오류: " + err.message); });
  }

  // ----- UI/플레이어 -----
  function renderList() {
    listEl.innerHTML = '';
    if (!localPlaylist.length) {
      listEl.innerHTML = '<div class="muted">재생목록이 비어있습니다.</div>';
      return;
    }
    localPlaylist.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span>${item.artist} - ${item.title}</span><button class="delete-btn" data-index="${index}">&#x2715;</button>`;
      
      // 삭제 버튼 이벤트 리스너 추가
      div.querySelector('.delete-btn').addEventListener('click', (e) => {
        const index = parseInt(e.target.dataset.index, 10);
        localPlaylist.splice(index, 1);
        renderList();
        debouncedSave(currentState());
      });

      listEl.appendChild(div);
    });
  }

  function getVideoId(url) {
    url = url.replace('music.youtube.com', 'www.youtube.com');
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
    const match = url.match(regex);
    return (match && match[1]) ? match[1] : null;
  }

  async function fetchVideoDetails(videoId) {
    const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
    const response = await fetch(apiUrl);
    const data = await response.json();
    if (data.items && data.items.length > 0) {
      const snippet = data.items[0].snippet;
      return {
        title: snippet.title,
        artist: snippet.channelTitle
      };
    } else {
      throw new Error("동영상 정보를 찾을 수 없습니다.");
    }
  }

  function currentState() {
    let videoId = '';
    if (player && player.getVideoData) {
        try {
            const data = player.getVideoData();
            if (data && data.video_id) {
                videoId = data.video_id;
            }
        } catch (e) {
            console.error("Error getting video ID from player:", e);
        }
    }
    return { 
      videoId: videoId,
      playlist: localPlaylist
    };
  }

  async function playNext() {
    if (!localPlaylist.length) {
      if (player && player.getPlayerState() !== YT.PlayerState.PAUSED) {
          player.pauseVideo();
          debouncedSave(currentState());
      }
      return;
    }
    
    let nextSong = null;
    const currentVideo = player ? player.getVideoData()?.video_id : null;
    const lastSong = localPlaylist[localPlaylist.length - 1];

    if (lastSong && lastSong.videoId !== currentVideo) {
      nextSong = lastSong;
    } else {
      const randomIdx = Math.floor(Math.random() * localPlaylist.length);
      nextSong = localPlaylist[randomIdx];
    }
    
    if (nextSong) {
      try {
        if (player) {
          player.loadVideoById(nextSong.videoId, 0);
          player.playVideo();
        }
      } catch {}
      debouncedSave(currentState());
    }
  }

  function wireUI() {
    addBtn.addEventListener('click', async () => {
      const url = (urlInput.value || '').trim();
      const videoId = getVideoId(url);
      if (!videoId) {
        showMessage("유효한 유튜브 링크 또는 ID를 입력해주세요.", 'error');
        return;
      }
      addBtn.textContent = '불러오는 중...';
      addBtn.disabled = true;

      try {
        const videoDetails = await fetchVideoDetails(videoId);
        localPlaylist.push({
          title: videoDetails.title,
          artist: videoDetails.channelTitle,
          videoId: videoId
        });
        renderList();
        
        debouncedSave(currentState());
        urlInput.value = '';
      } catch (e) {
        showMessage("동영상 정보를 가져오는 데 실패했습니다: " + e.message, 'error');
      } finally {
        addBtn.textContent = '추가';
        addBtn.disabled = false;
      }
    });

    volumeSlider.addEventListener('input', () => {
      if (playerReady) {
        player.setVolume(volumeSlider.value);
        if (player.isMuted()) {
          player.unMute();
        }
        lastVolume = volumeSlider.value;
        updateVolumeButton();
      }
    });

    volumeBtn.addEventListener('click', () => {
      if (playerReady) {
        if (player.isMuted()) {
          player.unMute();
          player.setVolume(lastVolume);
        } else {
          lastVolume = player.getVolume();
          player.mute();
        }
        updateVolumeButton();
      }
    });

    function updateVolumeButton() {
        const volumeIcon = document.getElementById('volume-up-icon');
        const muteIcon = document.getElementById('mute-icon');

        if (player.isMuted() || player.getVolume() === 0) {
            volumeIcon.style.display = 'none';
            muteIcon.style.display = 'block';
        } else {
            volumeIcon.style.display = 'block';
            muteIcon.style.display = 'none';
        }
    }
  }

  // ----- 시작 -----
  window.onload = function() {
    boot();
  };
</script>
</body>
</html>
